name: CI
'on':
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-dita:
    name: Build DITA
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2

      # 1) Build Bootstrap HTML
      - name: Build Bootstrap âš™ï¸
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends nodejs
            nodejs -v
          plugins: |
            fox.jason.extend.css
            net.infotexture.dita-bootstrap
            net.infotexture.dita-bootstrap.lunr
            fox.jason.prismjs
            fox.jason.favicon
            fox.jason.open-graph
          project: .github/dita-ot/html.xml

      # 2) Deploy HTML
      - name: Deploy HTML ðŸš€
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages
          FOLDER: out/html

      # 3) Build standard PDF
      - name: Build PDF ðŸ–¨ï¸
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends nodejs
            nodejs -v
          plugins: |
            fox.jason.extend.css
            fox.jason.prismjs
          build: |
            dita -i dita/document.ditamap -o out/pdf -f pdf \
                 --theme=.github/themes/theme.yaml \
                 --org.dita.index.skip="yes"

      # 4) Upload standard PDF
      - name: Upload PDF ðŸ“š
        uses: actions/upload-artifact@v4
        with:
          name: dita-pdf
          path: 'out/pdf'

  # 5) Build Tagged PDF (PDF/UA)
  build-tagged-pdf:
    name: Build Tagged PDF (PDF/UA) ðŸ·ï¸
    runs-on: ubuntu-latest
    needs: build-dita
    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      - name: Create folders
        run: |
          mkdir -p .github/fo
          mkdir -p .github/pdfua
          mkdir -p out/pdf-ua
          mkdir -p out/tmp-ua

      - name: Install dependencies (Node.js + DejaVu fonts)
        run: |
          sudo apt-get update -q
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get install -qy --no-install-recommends nodejs \
            fonts-dejavu-core
          nodejs -v
          # sanity: list the DejaVu files weâ€™ll reference
          ls -1 /usr/share/fonts/truetype/dejavu | sed -n '1,50p' || true

      - name: Write FOP config (PDF/UA + embedded DejaVu + robust aliases)
        run: |
          cat > .github/fo/fop.xconf <<'XML'
          <fop version="1.0">
            <strict-validation>false</strict-validation>
            <accessibility>true</accessibility>
            <renderers>
              <renderer mime="application/pdf">
                <pdf-ua-mode>PDF/UA-1</pdf-ua-mode>
                <fonts>
                  <!-- ===== Embed DejaVu Serif and alias Times* to it ===== -->
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSerif.ttf" kerning="yes">
                    <font-triplet name="DejaVu Serif" style="normal" weight="normal"/>
                    <font-triplet name="Times" style="normal" weight="normal"/>
                    <font-triplet name="Times-Roman" style="normal" weight="normal"/>
                  </font>
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSerif-Bold.ttf" kerning="yes">
                    <font-triplet name="DejaVu Serif" style="normal" weight="bold"/>
                    <font-triplet name="Times" style="normal" weight="bold"/>
                    <font-triplet name="Times-Bold" style="normal" weight="bold"/>
                  </font>
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSerif-Italic.ttf" kerning="yes">
                    <font-triplet name="DejaVu Serif" style="italic" weight="normal"/>
                    <font-triplet name="Times" style="italic" weight="normal"/>
                    <font-triplet name="Times-Italic" style="italic" weight="normal"/>
                  </font>
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSerif-BoldItalic.ttf" kerning="yes">
                    <font-triplet name="DejaVu Serif" style="italic" weight="bold"/>
                    <font-triplet name="Times" style="italic" weight="bold"/>
                    <font-triplet name="Times-BoldItalic" style="italic" weight="bold"/>
                  </font>

                  <!-- ===== Embed DejaVu Sans and alias Helvetica* to it ===== -->
                  <!-- Normal -->
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans" style="normal" weight="normal"/>
                    <font-triplet name="Helvetica" style="normal" weight="normal"/>
                  </font>
                  <!-- Bold -->
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans" style="normal" weight="bold"/>
                    <font-triplet name="Helvetica" style="normal" weight="bold"/>
                    <font-triplet name="Helvetica-Bold" style="normal" weight="bold"/>
                  </font>
                  <!-- Italic/Oblique -->
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSans-Oblique.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans" style="italic" weight="normal"/>
                    <font-triplet name="Helvetica" style="italic" weight="normal"/>
                    <!-- Handle PDF-style family literal with style=italic -->
                    <font-triplet name="Helvetica-Oblique" style="italic" weight="normal"/>
                    <!-- And handle it if style is treated as 'normal' (some generators do this) -->
                    <font-triplet name="Helvetica-Oblique" style="normal" weight="normal"/>
                  </font>
                  <!-- BoldItalic/BoldOblique -->
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSans-BoldOblique.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans" style="italic" weight="bold"/>
                    <font-triplet name="Helvetica" style="italic" weight="bold"/>
                    <font-triplet name="Helvetica-BoldOblique" style="italic" weight="bold"/>
                    <!-- Also guard for 'normal' style on PDF-style family -->
                    <font-triplet name="Helvetica-BoldOblique" style="normal" weight="bold"/>
                  </font>

                  <!-- ===== Embed DejaVu Sans Mono and alias Courier* to it ===== -->
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSansMono.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans Mono" style="normal" weight="normal"/>
                    <font-triplet name="Courier" style="normal" weight="normal"/>
                  </font>
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSansMono-Bold.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans Mono" style="normal" weight="bold"/>
                    <font-triplet name="Courier" style="normal" weight="bold"/>
                    <font-triplet name="Courier-Bold" style="normal" weight="bold"/>
                  </font>
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSansMono-Oblique.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans Mono" style="italic" weight="normal"/>
                    <font-triplet name="Courier" style="italic" weight="normal"/>
                    <font-triplet name="Courier-Oblique" style="italic" weight="normal"/>
                    <!-- Also handle normal style in case it's passed that way -->
                    <font-triplet name="Courier-Oblique" style="normal" weight="normal"/>
                  </font>
                  <font embed-url="/usr/share/fonts/truetype/dejavu/DejaVuSansMono-BoldOblique.ttf" kerning="yes">
                    <font-triplet name="DejaVu Sans Mono" style="italic" weight="bold"/>
                    <font-triplet name="Courier" style="italic" weight="bold"/>
                    <font-triplet name="Courier-BoldOblique" style="italic" weight="bold"/>
                    <font-triplet name="Courier-BoldOblique" style="normal" weight="bold"/>
                  </font>
                </fonts>
              </renderer>
            </renderers>
          </fop>
          XML

      - name: Write custom PDF/UA XSL (roles + frontmatter guards)
        run: |
          cat > .github/pdfua/pdfua.xsl <<'XSL'
          <?xml version="1.0" encoding="UTF-8"?>
          <xsl:stylesheet
              xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
              xmlns:fo="http://www.w3.org/1999/XSL/Format"
              version="2.0">
            <xsl:import href="plugin:org.dita.pdf2:xsl/fo/topic2fo.xsl"/>
            <xsl:import href="plugin:org.dita.pdf2:xsl/fo/static-content.xsl"/>

            <!-- Improve tagging -->
            <xsl:attribute-set name="topic.title" use-attribute-sets="__topic.title">
              <xsl:attribute name="role">H1</xsl:attribute>
            </xsl:attribute-set>
            <xsl:attribute-set name="section.title" use-attribute-sets="__section.title">
              <xsl:attribute name="role">H2</xsl:attribute>
            </xsl:attribute-set>

            <!-- Ensure frontmatter static-content is not empty -->
            <xsl:template name="insertFrontmatterOddHeader"><fo:block role="artifact">&#160;</fo:block></xsl:template>
            <xsl:template name="insertFrontmatterEvenHeader"><fo:block role="artifact">&#160;</fo:block></xsl:template>
            <xsl:template name="insertFrontmatterOddFooter"><fo:block role="artifact">&#160;</fo:block></xsl:template>
            <xsl:template name="insertFrontmatterEvenFooter"><fo:block role="artifact">&#160;</fo:block></xsl:template>
          </xsl:stylesheet>
          XSL

      - name: Build Tagged PDF (FOP/UA) + keep temp FO
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends nodejs
            nodejs -v
          plugins: |
            fox.jason.extend.css
            fox.jason.prismjs
          build: |
            XSL="$(pwd)/.github/pdfua/pdfua.xsl"
            FOPCONF="$(pwd)/.github/fo/fop.xconf"
            THEME="$(pwd)/.github/themes/theme.yaml"
            MAP="$(pwd)/dita/document.ditamap"
            OUT="$(pwd)/out/pdf-ua"
            TMP="$(pwd)/out/tmp-ua"

            echo "Using XSL: $XSL"
            echo "Using FOP config: $FOPCONF"
            echo "Temp dir: $TMP"

            dita -i "$MAP" \
                 -o "$OUT" \
                 -f pdf \
                 --theme="$THEME" \
                 --temp="$TMP" \
                 --clean.temp=no \
                 --args.fo.userconfig="$FOPCONF" \
                 --args.xsl.pdf="$XSL" \
                 --org.dita.index.skip="yes" \
                 --pdf.formatter=fop

      - name: Upload Tagged PDF ðŸ§©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dita-pdf-ua
          path: 'out/pdf-ua'

      - name: Upload FO temp for debugging ðŸ§ª
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ua-temp-fo
          path: 'out/tmp-ua'
