name: CI
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-dita:
    name: Build DITA
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2

      # 1) HTML
      - name: Build Bootstrap ‚öôÔ∏è
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends nodejs
            nodejs -v
          plugins: |
            fox.jason.extend.css
            net.infotexture.dita-bootstrap
            net.infotexture.dita-bootstrap.lunr
            fox.jason.prismjs
            fox.jason.favicon
            fox.jason.open-graph
          project: .github/dita-ot/html.xml

      - name: Deploy HTML üöÄ
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages
          FOLDER: out/html

      # 2) Styled PDF (non-tagged)
      - name: Build PDF üñ®Ô∏è
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends nodejs
            nodejs -v
          plugins: |
            fox.jason.extend.css
            fox.jason.prismjs
          build: |
            dita -i dita/document.ditamap -o out/pdf -f pdf \
                 --theme=.github/themes/theme.yaml \
                 -Dorg.dita.index.skip=yes

      - name: Upload PDF üìö
        uses: actions/upload-artifact@v4
        with:
          name: dita-pdf
          path: out/pdf

      # 3) Accessible PDF (FOP PDF/UA)
      - name: Build Accessible PDF (PDF/UA via FOP)
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends \
              fontconfig \
              fonts-dejavu fonts-liberation fonts-noto fonts-noto-cjk fonts-noto-color-emoji
            echo "Fonts installed:"; fc-list | wc -l
            echo "FOP userconfig exists?"; test -f "${GITHUB_WORKSPACE}/.github/fo/fop-userconfig.xml" && echo OK || (echo MISSING && exit 2)

          input: dita/document.ditamap
          transtype: pdf2
          args: |
            -Dargs.fo.userconfig=${GITHUB_WORKSPACE}/.github/fo/fop-userconfig.xml
            -Dpdf.formatter=fop
            # Ensure language metadata is present if not in the map/topics
            -Dargs.pdf.lang=en-US
            # Prefer document title over file name in metadata
            -Dpdf.pdfua.show-title=true
          output-path: out/pdf-accessible

      - name: List outputs (debug)
        run: |
          echo "=== OUT TREE ==="
          ls -R out || true

      - name: Upload Accessible PDF ‚ôø
        uses: actions/upload-artifact@v4
        with:
          name: dita-pdf-accessible
          path: out/pdf-accessible
