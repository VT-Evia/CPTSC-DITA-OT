name: CI

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-dita:
    name: Build DITA
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      # Ensure we own out/ before any Docker step writes as root
      - name: Prepare workspace dirs
        run: |
          mkdir -p out/html out/pdf
          chmod -R 777 out || true

      - name: Build Bootstrap âš™ï¸
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends nodejs
            nodejs -v
          plugins: |
            fox.jason.extend.css
            net.infotexture.dita-bootstrap
            net.infotexture.dita-bootstrap.lunr
            fox.jason.prismjs
            fox.jason.favicon
            fox.jason.open-graph
          project: .github/dita-ot/html.xml

      # Fix any root-owned files created by the container
      - name: Fix permissions (after HTML)
        if: always()
        run: |
          sudo chown -R "$USER:$USER" "$GITHUB_WORKSPACE/out" || true

      - name: Deploy HTML ðŸš€
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages
          FOLDER: out/html

      - name: Build PDF ðŸ–¨ï¸
        uses: dita-ot/dita-ot-action@4.3
        with:
          install: |
            apt-get update -q
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -qy --no-install-recommends nodejs
            nodejs -v
          plugins: |
            fox.jason.extend.css
            fox.jason.prismjs
          build: |
            # POSIX /bin/sh (no pipefail)
            set -eu
            THEME="$GITHUB_WORKSPACE/.github/themes/theme.yaml"
            LOGDIR="$GITHUB_WORKSPACE/out/pdf/logs"
            TEMPDIR="$GITHUB_WORKSPACE/out/pdf/temp"

            # Ensure dirs & files exist BEFORE tee/logging
            mkdir -p "$LOGDIR" "$TEMPDIR"
            RUNLOG="$LOGDIR/runner.log"
            DITALOG="$LOGDIR/dita.log"
            : > "$RUNLOG"
            : > "$DITALOG"

            echo "=== Paths ===" | tee -a "$RUNLOG"
            echo "THEME:   $THEME" | tee -a "$RUNLOG"
            echo "LOGDIR:  $LOGDIR" | tee -a "$RUNLOG"
            echo "TEMPDIR: $TEMPDIR" | tee -a "$RUNLOG"

            if [ ! -f "$THEME" ]; then
              echo "Theme file not found at $THEME" | tee -a "$RUNLOG"
              exit 1
            fi

            echo "=== Header/Footer excerpt from theme ===" | tee -a "$RUNLOG"
            awk 'f{print} /^(header:|footer:)/{f=1} /^style:/{exit}' "$THEME" | tee -a "$RUNLOG" || true

            # Run DITA-OT: note -v (verbose) instead of --verbosity
            dita -i "$GITHUB_WORKSPACE/dita/document.ditamap" \
                 -o "$GITHUB_WORKSPACE/out/pdf" \
                 -f pdf \
                 --theme="$THEME" \
                 --org.dita.index.skip="yes" \
                 -Dpdf.formatter=fop \
                 -Dargs.fo.userconfig="$GITHUB_WORKSPACE/fop/fop.xconf" \
                 -Dclean.temp=no \
                 -t "$TEMPDIR" \
                 -v \
                 --logfile "$DITALOG" 2>&1 | tee -a "$RUNLOG"

      # Make sure host steps can write even if the container created root-owned files
      - name: Fix permissions (after PDF)
        if: always()
        run: |
          sudo chown -R "$USER:$USER" "$GITHUB_WORKSPACE/out" || true

     

      # Upload PDF only on success
      - name: Upload PDF ðŸ“š
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dita-pdf
          path: out/pdf
